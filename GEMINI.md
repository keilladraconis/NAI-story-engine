## Gemini Added Memories
- The Brainstorm feature has been refactored from a card-based UI to a chat-based message stream interface and moved to its own sidebar tab.
- The Brainstorm agent has been optimized for short, conversational responses (max 300 tokens) to avoid relentless spewing of text.
- Ctrl+Enter is now bound to send in the Brainstorm chat, and the UI update delay has been fixed by rendering the user message immediately upon sending.
- The Brainstorm feature has been fully integrated into the World Snapshot workflow, using the chat history as input, and the legacy Brainstorm field definition has been removed from the UI configuration.
- The codebase has been refactored to use a `FieldID` enum instead of magic strings for identifying story fields, significantly improving type safety and maintainability in `StoryManager`, `StructuredEditor`, and `ContextStrategies`.
- The Review Stage uses a 'Streaming Patcher' with a 'Fuzzy Prefix Match' strategy: it matches the first 5 words of a locator, replacing punctuation with wildcards, and searches from the top of the text to handle out-of-order tags and formatting differences.
- Refactored Agent Workflow to remove `session.currentContent`. `StoryManager` is now the single source of truth for the current field draft, and `FieldSession` tracks only workflow state. Stages reference `StoryManager` or `session.cycles` directly.
- Removed redundant fields `originalContent`, `isActive`, and `progress` from `FieldSession`. `AgentCycleManager.startSession` no longer accepts `originalContent` as an argument.
- Refactored `StructuredEditor.createFieldSection` to use the Strategy Pattern via `FieldRenderStrategy`. Rendering logic is now separated into `src/ui/field-strategies.ts`.
- Refactored `FieldStrategies` to use configuration-based selection (`layout: "inline-wand"`) instead of hardcoded Field IDs. Renamed `WorldSnapshotStrategy` to `InlineWandStrategy` to reflect this decoupling.
- Removed `ActiveWandStrategy`, `WandUI.createWorkflowUI`, and redundant generic wand logic. The system now exclusively supports "Inline Wand" (e.g. World Snapshot) via the `layout: "inline-wand"` configuration, or standard fields. Modal/Generic Wand support has been removed as it was unused.
- Refactored `AgentWorkflowService` to delegate review patching logic to a new `ReviewPatcher` service (`src/core/review-patcher.ts`), simplifying the `runStageGeneration` method.
- Refactored `runStageGeneration` to use the Strategy Pattern via `StageHandler`. Implemented `GenerateStageHandler`, `ReviewStageHandler`, and `RefineStageHandler` in `src/core/stage-handlers.ts`, removing all stage-conditional logic from the main workflow service.
- Refactored `BrainstormService` to load `brainstorm_prompt` from the configuration instead of using a hardcoded string.
- Architectural Overhaul (Jan 2026): Implemented Strategy Patterns for Field Rendering (`FieldRenderStrategy`) and Agent Stages (`StageHandler`). Extracted `ReviewPatcher` for logic encapsulation. Removed `session.currentContent` to make `StoryManager` the single source of truth. Removed dead code (`ActiveWandStrategy`).
- DULFS list items no longer overwrite linked Lorebook Entry text during sync unless the content was explicitly edited in the Story Engine Lorebook Panel (i.e., `lorebookContent` is defined). This protects manual user edits made directly in the NAI Lorebook UI.
- User does not care about Import/Export features for the Story Engine project.
- The Story Engine project prefers moving business logic (like parsing and syncing orchestration) into `StoryManager` to keep UI strategies (`FieldRenderStrategy`) focused purely on rendering. regex patterns should be in `FIELD_CONFIGS`.
- Implemented "S.E.G.A." (Story Engine Generate All), a master generation queue system. It features a modal UI that lists all fields and lorebooks, processes them sequentially, dynamically adds new lorebook entries found during DULFS generation, and provide a master responsive generate button that handles budget states and cancellation for the active item. Logic resides in `SegaService` and UI in `SegaModal`.
- S.E.G.A. Queuing Strategy (Jan 9, 2026): Updated SegaService to interleave generation requests. Instead of queuing all items of one category before moving to the next, it now queues one item from each category in a round-robin fashion. This ensures broad coverage (e.g., getting some Factions, some Characters, some Systems) early in the process rather than waiting for entire lists to complete.
- Fixed bug in S.E.G.A. modal where the countdown timer was not displaying during 'Waiting...' state because `budgetTimeRemaining` was not being passed to the button component.
- Added Edit, Delete, and Retry functionality to the Brainstorm chat interface. Refactored BrainstormService to separate message addition and generation logic. Updated BrainstormUI to include edit modes and action buttons for messages.
- **Brainstorm Workflow Integration (Jan 12, 2026)**: Integrated Brainstorming into `AgentWorkflowService`. The "Send" button now participates in the global generation queue, respecting `isGlobalGenerating` locks and displaying "Queued", "Waiting... (timer)", or "Thinking..." states. `BrainstormService` was refactored to separate message management from generation execution, allowing the workflow to orchestrate the generation process including budget handling.
- **Robust Cancellation (Jan 12, 2026)**: Enhanced the cancellation logic for generation sessions. Clicking "Waiting..." during a budget pause now triggers a rejection of the budget wait promise via `budgetRejecter`, ensuring that `hyperGenerate` aborts immediately rather than proceeding when the budget becomes available. This applies to Field, List, and Brainstorm generation. Brainstorm UI now prompts "Continue...?" when waiting for user confirmation.
- **Fast S.E.G.A. Mode (Jan 12, 2026)**: Implemented "Fast S.E.G.A." mode for quick bootstrapping. If S.E.G.A. is activated while Story Prompt, ATTG, and Style Guidelines are empty and unbound, a modal prompts the user to bootstrap the story. If accepted, it automatically binds these fields (to Lorebook, Memory, and Author's Note respectively), queues their generation, and then proceeds with normal background generation. These bootstrap tasks are tracked by `SegaService` to ensure auto-resolution of budget waits.
- **UI Refresh Fixes (Jan 12, 2026)**: Fixed issues where streaming output wasn't visible and the UI didn't update after generation.
  - Subscribed `StoryEngineUI` to `AgentWorkflowService` to trigger re-renders during streaming.
  - Updated `StoryManager.setFieldContent` to explicitly notify listeners after saving (both for `immediate` and `debounce` persistence), ensuring the UI reflects final generation states.